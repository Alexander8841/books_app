<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{{ book.title }} - Reviews</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* Контейнер отзывов с плавным переходом */
        .reviews-container {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            transition: all 0.8s ease;
        }

        /* Отдельная карточка отзыва с анимацией появления */
        .review-card {
            transform: translateY(-10px);
            opacity: 0;
            animation: appear 0.9s forwards;
        }

        @keyframes appear {
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Звёзды для рейтинга */
        .star {
            font-size: 1.5rem;
            cursor: pointer;
        }
    </style>
</head>
<body class="bg-light">
<div class="container py-5">
    <a href="{{ url_for('index') }}" class="btn btn-secondary mb-3">⬅ Назад к списку книг</a>
    <h2>{{ book.title }}</h2>
    <h5 class="text-muted">{{ book.author }}</h5>

    <hr>
    <h4>Добавить отзыв</h4>
    <form id="review-form" class="mb-4">
        <div class="mb-3">
            <label class="form-label">Рейтинг</label>
            <div id="star-rating" class="d-flex gap-1">
                {% for i in range(1, 6) %}
                <span class="star" data-value="{{ i }}">&#9734;</span>
                {% endfor %}
            </div>
            <input type="hidden" id="rating" name="rating" required>
        </div>
        <div class="mb-3">
            <label for="review_text" class="form-label">Текст отзыва</label>
            <textarea class="form-control" id="review_text" name="review_text" rows="3"></textarea>
        </div>
        <button type="submit" class="btn btn-success">Добавить отзыв</button>
    </form>

    <hr>
    <h4>Отзывы</h4>
    <div id="reviews" class="reviews-container">
        {% if reviews %}
            {% for r in reviews %}
            <div class="review-card card mb-2 shadow-sm">
                <div class="card-body">
                    <p><strong>Рейтинг:</strong> {{ "★"*r.rating }}{{ "☆"*(5 - r.rating) }}</p>
                    <p>{{ r.review_text }}</p>
                    <small class="text-muted">{{ r.created_at.strftime("%Y-%m-%d") }}</small>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <p>Нет отзывов</p>
        {% endif %}
    </div>
</div>

<script>
const stars = document.querySelectorAll("#star-rating .star");
const ratingInput = document.getElementById("rating");
const reviewsContainer = document.getElementById("reviews");

// Выбор рейтинга
stars.forEach((star, index) => {
    star.addEventListener("click", () => {
        ratingInput.value = index + 1;
        stars.forEach((s, i) => s.innerHTML = i <= index ? "★" : "☆");
    });
});

// Отправка формы
document.getElementById("review-form").addEventListener("submit", async (e) => {
    e.preventDefault();

    const rating = ratingInput.value;
    const reviewText = document.getElementById("review_text").value;
    const bookId = {{ book.id }};

    if (!rating) {
        alert("Выберите рейтинг!");
        return;
    }

    const response = await fetch(`/books/${bookId}/review`, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({rating, review_text: reviewText})
    });

    const data = await response.json();

    if (response.ok) {
        const reviewDiv = document.createElement("div");
        reviewDiv.className = "review-card card mb-2 shadow-sm";
        reviewDiv.innerHTML = `
            <div class="card-body">
                <p><strong>Рейтинг:</strong> ${"★".repeat(data.review.rating)}${"☆".repeat(5 - data.review.rating)}</p>
                <p>${data.review.review_text}</p>
                <small class="text-muted">${data.review.created_at}</small>
            </div>
        `;
        reviewsContainer.prepend(reviewDiv);
        void reviewDiv.offsetWidth; // триггерим анимацию
        document.getElementById("review-form").reset();
        stars.forEach(s => s.innerHTML = "☆");
    } else {
        alert(data.error || "Ошибка при добавлении отзыва");
    }
});
</script>
</body>
</html>
